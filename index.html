<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PumpFun Widget</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: transparent;
            height: 100vh;
            overflow: hidden;
        }

        /* Market Cap Display */
        .marketcap-widget {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 15px 25px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            z-index: 100;
        }

        .marketcap {
            color: #00ff88;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .marketcap-label {
            color: #ffffff;
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Transaction Notification */
        .transaction-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            border: 3px solid #fff;
            border-radius: 20px;
            padding: 30px 40px;
            text-align: center;
            color: white;
            box-shadow: 0 0 40px rgba(255, 107, 107, 0.6);
            z-index: 200;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 500px;
        }

        .transaction-notification.milestone {
            background: linear-gradient(135deg, #00ff88, #0066ff);
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.6);
        }

        .transaction-notification.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .transaction-amount {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .transaction-text {
            font-size: 18px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .transaction-user {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
            font-family: monospace;
            word-break: break-all;
        }

        /* Roulette Wheel */
        .roulette-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            z-index: 300;
            transition: all 0.8s ease;
        }

        .roulette-container.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .roulette-wheel {
            width: 400px;
            height: 400px;
            border: 8px solid #fff;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(
                from 0deg,
                #ff6b6b 0deg 72deg,
                #4ecdc4 72deg 144deg,
                #45b7d1 144deg 216deg,
                #f9ca24 216deg 288deg,
                #f0932b 288deg 360deg
            );
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
            transition: transform 4s cubic-bezier(0.23, 1, 0.320, 1);
        }

        .roulette-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #fff;
            z-index: 10;
        }

        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .task-segments {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .segment:nth-child(1) { transform: rotate(0deg) skew(-18deg); }
        .segment:nth-child(2) { transform: rotate(72deg) skew(-18deg); }
        .segment:nth-child(3) { transform: rotate(144deg) skew(-18deg); }
        .segment:nth-child(4) { transform: rotate(216deg) skew(-18deg); }
        .segment:nth-child(5) { transform: rotate(288deg) skew(-18deg); }

        /* Task Result */
        .task-result {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid #fff;
            border-radius: 15px;
            padding: 20px 30px;
            color: white;
            text-align: center;
            opacity: 0;
            transition: all 0.6s ease;
            max-width: 400px;
        }

        .task-result.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .task-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .task-description {
            font-size: 16px;
            line-height: 1.4;
        }

        /* Controls - removed, now only console access */

        /* Status */
        .status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
        }

        .status.active {
            border-left: 4px solid #00ff88;
        }

        .status.error {
            border-left: 4px solid #ff4444;
        }

        /* Milestone Progress */
        .milestone-progress {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            min-width: 250px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #0066ff);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- Market Cap Widget -->
    <div class="marketcap-widget">
        <div class="marketcap" id="marketcap">Loading...</div>
        <div class="marketcap-label">Market Cap</div>
    </div>

    <!-- Transaction Notification -->
    <div class="transaction-notification" id="transactionNotification">
        <div class="transaction-amount" id="transactionAmount">5 SOL</div>
        <div class="transaction-text" id="transactionText">BIG BUY DETECTED!</div>
        <div class="transaction-user" id="transactionUser">User: 7xKq...Mx9A</div>
        <div style="font-size: 14px; opacity: 0.8;">Time for a challenge...</div>
    </div>

    <!-- Roulette Wheel -->
    <div class="roulette-container" id="rouletteContainer">
        <div class="roulette-pointer"></div>
        <div class="roulette-wheel" id="rouletteWheel">
            <div class="task-segments" id="taskSegments">
                <div class="segment">Loading...</div>
                <div class="segment">Tasks...</div>
                <div class="segment">Please</div>
                <div class="segment">Wait...</div>
                <div class="segment">...</div>
            </div>
            <div class="roulette-center">SPIN</div>
        </div>
    </div>

    <!-- Task Result -->
    <div class="task-result" id="taskResult">
        <div class="task-title" id="taskTitle">CHALLENGE SELECTED!</div>
        <div class="task-description" id="taskDescription">Your task will appear here...</div>
    </div>

    <!-- Status -->
    <div class="status active" id="status">
        ðŸŸ¢ Monitoring transactions...
    </div>

    <!-- Milestone Progress -->
    <div class="milestone-progress" id="milestoneProgress">
        <div style="font-size: 12px; opacity: 0.8;">Next Milestone</div>
        <div style="font-weight: bold; margin: 5px 0;" id="milestoneText">$10,000</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        <div style="font-size: 11px; opacity: 0.6;" id="progressText">$0 / $10,000</div>
    </div>

    <script>
        // Default configuration - Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¼ÐµÐ½ÐµÐ½ Ð½Ð° Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· config.json
        let config = {
            tokenContract: 'FyB8VxxYAaVVchAgbB1kvjWdw26ovaD4ipwV1j8epump',
            buyThresholds: {
                lowCap: { marketCapLimit: 50000, minBuyAmount: 5 }, // 5 SOL Ð¿Ñ€Ð¸ ÐºÐ°Ð¿Ðµ < 50k
                alwaysActive: [50, 500] // 50 SOL Ð¸ 500 SOL Ð²ÑÐµÐ³Ð´Ð° Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹
            },
            marketCapMilestones: [
                { min: 0, max: 100000, step: 10000, description: "Early Stage" },
                { min: 100000, max: 500000, step: 50000, description: "Growth Stage" },
                { min: 500000, max: 1000000, step: 100000, description: "Advanced Stage" },
                { min: 1000000, max: 5000000, step: 100000, description: "Mature Stage" },
                { min: 5000000, max: 999999999, step: 500000, description: "Elite Stage" }
            ],
            monitoringSettings: {
                marketCapCheckInterval: 5000,
                transactionCheckInterval: 3000,
                enableTransactionMonitoring: false,
                enableMilestoneMonitoring: true
            }
        };

        let tasks = [
            "Do 10 pushups right now! ðŸ’ª",
            "Drink a full glass of water ðŸ’§",
            "Say something positive about the project ðŸš€",
            "Dance for 1 minute ðŸ•º",
            "Tell the chat your best crypto joke ðŸ˜‚"
        ];

        let specialTasks = {
            milestone: [],
            bigBuy: [],
            regular: []
        };

        // State
        let currentMarketCap = 0;
        let lastCheckedCap = 0;
        let nextMilestone = 10000;
        let isAnimating = false;

        // DOM Elements
        const marketCapElement = document.getElementById('marketcap');
        const transactionNotification = document.getElementById('transactionNotification');
        const rouletteContainer = document.getElementById('rouletteContainer');
        const rouletteWheel = document.getElementById('rouletteWheel');
        const taskResult = document.getElementById('taskResult');
        const statusElement = document.getElementById('status');
        const milestoneProgress = document.getElementById('milestoneProgress');

        // Initialize
        init();

        async function init() {
            console.log('ðŸš€ Advanced PumpFun Widget initialized');
            updateTaskSegments();
            startMonitoring();
        }

        function updateTaskSegments() {
            const segments = document.getElementById('taskSegments');
            segments.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const segment = document.createElement('div');
                segment.className = 'segment';
                segment.textContent = tasks[i] || `Task ${i + 1}`;
                segments.appendChild(segment);
            }
        }

        async function fetchMarketCap() {
            try {
                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${config.tokenContract}`);
                const data = await response.json();
                
                if (data.pairs && data.pairs.length > 0) {
                    const bestPair = data.pairs.reduce((best, current) => {
                        const bestLiq = parseFloat(best.liquidity?.usd || 0);
                        const currentLiq = parseFloat(current.liquidity?.usd || 0);
                        return currentLiq > bestLiq ? current : best;
                    });
                    
                    const marketCap = parseFloat(bestPair.marketCap || bestPair.fdv || 0);
                    return marketCap;
                }
                return 0;
            } catch (error) {
                console.error('Error fetching market cap:', error);
                return 0;
            }
        }

        function formatMarketCap(value) {
            if (value >= 1000000000) {
                return `$${(value / 1000000000).toFixed(2)}B`;
            } else if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(2)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(2)}K`;
            } else {
                return `$${value.toFixed(2)}`;
            }
        }

        function getCurrentMilestoneConfig(marketCap) {
            for (const milestone of config.marketCapMilestones) {
                if (marketCap >= milestone.min && marketCap < milestone.max) {
                    return milestone;
                }
            }
            return config.marketCapMilestones[config.marketCapMilestones.length - 1];
        }

        function getNextMilestone(marketCap) {
            const milestoneConfig = getCurrentMilestoneConfig(marketCap);
            const currentStep = Math.floor(marketCap / milestoneConfig.step) * milestoneConfig.step;
            return currentStep + milestoneConfig.step;
        }

        function updateMilestoneProgress() {
            const milestone = getNextMilestone(currentMarketCap);
            const previousMilestone = milestone - getCurrentMilestoneConfig(currentMarketCap).step;
            const progress = ((currentMarketCap - previousMilestone) / (milestone - previousMilestone)) * 100;
            
            document.getElementById('milestoneText').textContent = formatMarketCap(milestone);
            document.getElementById('progressFill').style.width = `${Math.max(0, Math.min(100, progress))}%`;
            document.getElementById('progressText').textContent = 
                `${formatMarketCap(currentMarketCap)} / ${formatMarketCap(milestone)}`;
            
            nextMilestone = milestone;
        }

        async function checkForMilestone(newMarketCap, oldMarketCap) {
            const oldMilestone = getNextMilestone(oldMarketCap);
            const newMilestone = getNextMilestone(newMarketCap);
            
            if (newMarketCap >= oldMilestone && oldMarketCap < oldMilestone) {
                console.log(`ðŸŽ¯ Milestone reached: ${formatMarketCap(oldMilestone)}`);
                await showMilestoneNotification(formatMarketCap(oldMilestone));
                setTimeout(() => spinRoulette('milestone'), 2500);
            }
        }

        async function showMilestoneNotification(amount) {
            if (isAnimating) return;
            isAnimating = true;
            
            const notification = document.getElementById('transactionNotification');
            document.getElementById('transactionAmount').textContent = amount;
            document.getElementById('transactionText').textContent = 'MILESTONE REACHED!';
            document.getElementById('transactionUser').textContent = `Market Cap: ${amount}`;
            
            notification.classList.add('milestone', 'show');
            
            return new Promise(resolve => {
                setTimeout(() => {
                    notification.classList.remove('show', 'milestone');
                    setTimeout(() => {
                        isAnimating = false;
                        resolve();
                    }, 500);
                }, 2000);
            });
        }

        async function showBuyNotification(amount, userAddress) {
            if (isAnimating) return;
            isAnimating = true;
            
            const notification = document.getElementById('transactionNotification');
            document.getElementById('transactionAmount').textContent = `${amount} SOL`;
            document.getElementById('transactionText').textContent = 'BIG BUY DETECTED!';
            document.getElementById('transactionUser').textContent = `User: ${userAddress.slice(0, 4)}...${userAddress.slice(-4)}`;
            
            notification.classList.add('show');
            
            return new Promise(resolve => {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        isAnimating = false;
                        resolve();
                    }, 500);
                }, 2000);
            });
        }

        async function startMonitoring() {
            const interval = config.monitoringSettings?.marketCapCheckInterval || 5000;
            
            setInterval(async () => {
                if (isAnimating) return;
                
                const newMarketCap = await fetchMarketCap();
                if (newMarketCap > 0) {
                    marketCapElement.textContent = formatMarketCap(newMarketCap);
                    
                    // Check for milestones only if enabled
                    if (config.monitoringSettings?.enableMilestoneMonitoring !== false && currentMarketCap > 0) {
                        await checkForMilestone(newMarketCap, currentMarketCap);
                    }
                    
                    currentMarketCap = newMarketCap;
                    updateMilestoneProgress();
                    
                    statusElement.className = 'status active';
                    statusElement.textContent = `ðŸŸ¢ Monitoring ${getCurrentMilestoneConfig(newMarketCap).description || 'Active'}`;
                } else {
                    statusElement.className = 'status error';
                    statusElement.textContent = 'ðŸ”´ API Error';
                }
            }, interval);
        }

        async function showTransactionNotification(amount, text) {
            // This function is now split into showBuyNotification and showMilestoneNotification
            console.log('Legacy function called - use showBuyNotification or showMilestoneNotification instead');
        }

        function getRandomTask(type = 'regular') {
            const availableTasks = specialTasks[type] || tasks;
            if (availableTasks.length === 0) return tasks[0];
            
            return availableTasks[Math.floor(Math.random() * availableTasks.length)];
        }

        async function spinRoulette(taskType = 'regular') {
            if (isAnimating) return;
            isAnimating = true;
            
            rouletteContainer.classList.add('show');
            
            // Select task based on type
            const selectedTask = getRandomTask(taskType);
            
            // Random rotation (multiple full spins + random position)
            const randomSpin = 1440 + Math.random() * 1440; // 4-8 full rotations
            const selectedTaskIndex = Math.floor(Math.random() * 5); // Visual only
            const targetRotation = randomSpin + (selectedTaskIndex * 72); // 72 degrees per segment
            
            rouletteWheel.style.transform = `rotate(${targetRotation}deg)`;
            
            const duration = config.uiSettings?.rouletteDuration || 4000;
            const resultDuration = config.uiSettings?.taskResultDuration || 4000;
            
            setTimeout(() => {
                showTaskResult(selectedTask, taskType);
            }, duration);
            
            setTimeout(() => {
                rouletteContainer.classList.remove('show');
                setTimeout(() => {
                    rouletteWheel.style.transform = 'rotate(0deg)';
                    isAnimating = false;
                }, 800);
            }, duration + resultDuration);
        }

        function showTaskResult(task, type = 'regular') {
            const title = type === 'milestone' ? 'ðŸŽ‰ MILESTONE TASK!' :
                         type === 'bigBuy' ? 'ðŸ‹ WHALE TASK!' : 
                         'ðŸŽ¯ CHALLENGE SELECTED!';
            
            document.getElementById('taskTitle').textContent = title;
            document.getElementById('taskDescription').textContent = task;
            taskResult.classList.add('show');
            
            const duration = config.uiSettings?.taskResultDuration || 4000;
            setTimeout(() => {
                taskResult.classList.remove('show');
            }, duration);
        }

        // Test functions
        async function testTransaction() {
            await showTransactionNotification('$1,234', 'BIG BUY DETECTED!');
            setTimeout(() => spinRoulette('bigBuy'), 500);
        }

        async function testMilestone() {
            await showTransactionNotification('$50K', 'MILESTONE REACHED!');
            setTimeout(() => spinRoulette('milestone'), 500);
        }

        function testRoulette() {
            spinRoulette('regular');
        }

        // Load custom config if available
        async function loadConfig() {
            try {
                const response = await fetch('./config.json');
                if (!response.ok) throw new Error('Config not found');
                
                const customConfig = await response.json();
                config = { ...config, ...customConfig };
                
                console.log('âœ… Custom config loaded:', config);
                updateMilestoneProgress(); // Refresh with new config
            } catch (error) {
                console.log('âš ï¸ Using default config - config.json not found or invalid');
            }
        }

        // Load custom tasks if available  
        async function loadTasks() {
            try {
                const response = await fetch('./tasks.json');
                if (!response.ok) throw new Error('Tasks not found');
                
                const tasksData = await response.json();
                
                // Load different task types
                if (tasksData.tasks) {
                    tasks = tasksData.tasks;
                    specialTasks.regular = tasksData.tasks;
                }
                
                if (tasksData.milestoneSpecialTasks) {
                    specialTasks.milestone = tasksData.milestoneSpecialTasks;
                }
                
                if (tasksData.bigBuyTasks) {
                    specialTasks.bigBuy = tasksData.bigBuyTasks;
                }
                
                updateTaskSegments();
                console.log('âœ… Custom tasks loaded');
                console.log(`- Regular tasks: ${specialTasks.regular.length}`);
                console.log(`- Milestone tasks: ${specialTasks.milestone.length}`);
                console.log(`- Big buy tasks: ${specialTasks.bigBuy.length}`);
                
            } catch (error) {
                console.log('âš ï¸ Using default tasks - tasks.json not found or invalid');
                specialTasks.regular = tasks;
            }
        }

        // Load configs on startup
        loadConfig().then(() => loadTasks());
    </script>
</body>
</html>
