<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Market Cap Widget</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .widget {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px 30px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }

        .widget::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00ff88, #0066ff, #00ff88);
            border-radius: 15px;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite alternate;
        }

        @keyframes borderGlow {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .marketcap {
            color: #00ff88;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            transition: all 0.3s ease;
        }

        .marketcap.updating {
            color: #ffa500;
            transform: scale(1.05);
        }

        .label {
            color: #ffffff;
            font-size: 14px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status {
            position: absolute;
            top: 5px;
            right: 10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        .status.error {
            background: #ff4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .error-message {
            color: #ff4444;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="widget">
        <div class="status" id="status"></div>
        <div class="label">Market Cap</div>
        <div class="marketcap" id="marketcap">Loading...</div>
        <div class="error-message" id="error" style="display: none;"></div>
    </div>

    <script>
        const TOKEN_CONTRACT = 'FyB8VxxYAaVVchAgbB1kvjWdw26ovaD4ipwV1j8epump';
        const UPDATE_INTERVAL = 5000; // 5 seconds
        
        const marketCapElement = document.getElementById('marketcap');
        const statusElement = document.getElementById('status');
        const errorElement = document.getElementById('error');

        let lastMarketCap = null;

        function formatMarketCap(value) {
            if (value >= 1000000000) {
                return `$${(value / 1000000000).toFixed(2)}B`;
            } else if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(2)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(2)}K`;
            } else {
                return `$${value.toFixed(2)}`;
            }
        }

        async function fetchMarketCap() {
            try {
                marketCapElement.classList.add('updating');
                statusElement.classList.remove('error');
                errorElement.style.display = 'none';

                // Use DexScreener as it has CORS enabled and tracks PumpFun tokens
                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${TOKEN_CONTRACT}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('DexScreener Response:', data);
                
                let marketCap = null;
                
                // Parse DexScreener response for PumpFun tokens
                if (data.pairs && data.pairs.length > 0) {
                    // Look for the pair with highest liquidity or most recent
                    const bestPair = data.pairs.reduce((best, current) => {
                        const bestLiq = parseFloat(best.liquidity?.usd || 0);
                        const currentLiq = parseFloat(current.liquidity?.usd || 0);
                        return currentLiq > bestLiq ? current : best;
                    });
                    
                    if (bestPair.marketCap) {
                        marketCap = parseFloat(bestPair.marketCap);
                    } else if (bestPair.fdv) {
                        marketCap = parseFloat(bestPair.fdv);
                    } else if (bestPair.priceUsd && bestPair.info?.totalSupply) {
                        marketCap = parseFloat(bestPair.priceUsd) * parseFloat(bestPair.info.totalSupply);
                    }
                }

                if (marketCap && marketCap > 0) {
                    const formattedValue = formatMarketCap(marketCap);
                    marketCapElement.textContent = formattedValue;
                    
                    // Add visual feedback for changes
                    if (lastMarketCap !== null && lastMarketCap !== marketCap) {
                        if (marketCap > lastMarketCap) {
                            marketCapElement.style.color = '#00ff88';
                        } else {
                            marketCapElement.style.color = '#ff4444';
                        }
                        
                        setTimeout(() => {
                            marketCapElement.style.color = '#00ff88';
                        }, 1000);
                    }
                    
                    lastMarketCap = marketCap;
                } else {
                    throw new Error('No valid market cap data found');
                }

            } catch (error) {
                console.error('Error fetching market cap:', error);
                
                // Try Birdeye API as fallback
                try {
                    const birdeyeResponse = await fetch(`https://public-api.birdeye.so/defi/token_overview?address=${TOKEN_CONTRACT}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });

                    if (birdeyeResponse.ok) {
                        const birdeyeData = await birdeyeResponse.json();
                        console.log('Birdeye Response:', birdeyeData);
                        
                        if (birdeyeData.data && birdeyeData.data.mc) {
                            const marketCap = parseFloat(birdeyeData.data.mc);
                            const formattedValue = formatMarketCap(marketCap);
                            marketCapElement.textContent = formattedValue;
                            statusElement.classList.remove('error');
                            errorElement.style.display = 'none';
                            return;
                        }
                    }
                } catch (fallbackError) {
                    console.log('Fallback API also failed:', fallbackError);
                }
                
                // If all APIs fail
                statusElement.classList.add('error');
                errorElement.textContent = 'API Unavailable';
                errorElement.style.display = 'block';
                marketCapElement.textContent = 'Check Later';
            } finally {
                marketCapElement.classList.remove('updating');
            }
        }

        async function tryAlternativeMethod() {
            // This function is no longer needed
        }

        // Initial fetch
        fetchMarketCap();

        // Set up periodic updates
        setInterval(fetchMarketCap, UPDATE_INTERVAL);

        // Add click to manually refresh
        marketCapElement.addEventListener('click', fetchMarketCap);
    </script>
</body>
</html>